<div class="row">
  <div *ngIf="dataSource$ | async as data" class="col-12">
    <div class="mdc-card mb-3" style="overflow: hidden;">
      <!-- Card Header -->
      <div id="card-header" class="d-flex tgt-bg px-4 py-3 align-items-center">
        <h3 class="m-0 text-white flex-fill align-items-center">
          Sales Order Entry
          <img *ngIf="loading" width="23px" src="assets/icons/rolling_white.svg" alt="Rolling White">
        </h3>
        <div>
          <button (click)="toggleView()" class="tgt-button-full tgt-btn-white h-100 px-3 py-2 my-1 mr-3">
            {{ view ? 'Master View' : 'Normal View' }}
          </button>
          <button (click)="viewPDF()" class="tgt-button-full tgt-btn-white h-100 px-3 py-2 my-1 mr-3" [disabled]="arrLength <= 0">
            Preview Doc
          </button>
          
          <button (click)="savePDF()" class="tgt-button-full tgt-btn-white h-100 px-3 py-2 my-1 mr-3" [disabled]="arrLength <= 0">
            Save Doc
          </button>
          <button dialogTrigger="process" class="tgt-button-full tgt-btn-white h-100 px-3 py-2 my-1" [disabled]="arrLength <= 0">
            Save & Process Doc
          </button>
          <!-- <button (click)="resetDoc()" class="tgt-button-full tgt-btn-white h-100 px-3 py-2 my-1">
            Reset Doc
          </button> -->
        </div>
      </div>

      <!-- Card Subheader -->
      <div id="card-subheader" class="py-3 px-4 d-flex justify-content-between">
        <div class="alert alert-info position-relative mb-0" style="width: 500px;">
          <span class="font-weight-bold">{{data?.customerCode}}</span> - {{data?.company_name}}
          <!-- <button (click)="unassign()" type="button" class="close" data-dismiss="alert" aria-label="Close">
            <i class="material-icons" style="pointer-events:none" aria-hidden="true">close</i>
          </button> -->
        </div>
        <button dialogTrigger="newprod" class="tgt-button-full tgt-btn-white h-100 px-3 py-2">
          Add Product
        </button>
      </div>

      <!-- Data Table -->
      <table cdk-table [dataSource]="prodEnt$" [trackBy]="trackByFn" class="table table-hover table-bordered tgt-table tgt-scroll" respHeight>
        <tr cdk-header-row *cdkHeaderRowDef="columns"></tr>
        <tr
          cdk-row
          *cdkRowDef="let row; columns: columns"
          [ngClass]="{
            'table-danger': row.status === 'delete',
            'table-success': row.status === 'new',
            'table-danger': +row.qty >= +row.Qty_On_Hand
          }"
        ></tr>
        <tr cdk-footer-row *cdkFooterRowDef="columns"></tr>

        <ng-container cdkColumnDef="p_id">
          <th cdk-header-cell *cdkHeaderCellDef style="width: 10%;">Item Code</th>
          <td cdk-cell *cdkCellDef="let row" class="text-center font-weight-bold" style="width: 10%;">
            {{row.p_id}}
          </td>
          <td cdk-footer-cell *cdkFooterCellDef style="width: 10%;"></td>
        </ng-container>
        <ng-container cdkColumnDef="des">
          <th cdk-header-cell *cdkHeaderCellDef style="width: 25%;">Description</th>
          <td cdk-cell *cdkCellDef="let row" class="text-left" style="width: 25%;">
            {{row.Description_1}}<br>{{row.Description_2}}
          </td>
          <td cdk-footer-cell *cdkFooterCellDef style="width: 25%;"></td>
        </ng-container>
        <ng-container cdkColumnDef="brand">
          <th cdk-header-cell *cdkHeaderCellDef style="width: 9%;">Brand</th>
          <td cdk-cell *cdkCellDef="let row" class="text-left" style="width: 9%;">
            {{row.Description_3}}
          </td>
          <td cdk-footer-cell *cdkFooterCellDef style="width: 9%;"></td>
        </ng-container>
        <ng-container cdkColumnDef="stock">
          <th cdk-header-cell *cdkHeaderCellDef style="width: 9%;">Available</th>
          <td cdk-cell *cdkCellDef="let row" class="text-right table-active" style="width: 9%;">
            {{row.Qty_On_Hand | number:'1.0-0'}}
          </td>
          <td cdk-footer-cell *cdkFooterCellDef style="width: 9%;"></td>
        </ng-container>
        <ng-container cdkColumnDef="qty">
          <th cdk-header-cell *cdkHeaderCellDef style="width: 5%;">Qty</th>
          <td cdk-cell *cdkCellDef="let row; index as i;" class="d-flex p-0"  style="width: 5%;">
            <input (change)="updateVal(i, $event)" type="number" name="qty" id="qty" value="{{row.qty}}" class="no-border w-100 text-right">
          </td>
          <td cdk-footer-cell *cdkFooterCellDef style="width: 5%;"></td>
        </ng-container>
        <ng-container cdkColumnDef="defprice">
          <th cdk-header-cell *cdkHeaderCellDef style="width: 10%;" [hidden]="!view">Default Price<br>Rs.</th>
          <td cdk-cell *cdkCellDef="let row" class="text-right table-active" [hidden]="!view" style="width: 10%;">
            {{row.fExclPrice2 | number:'1.2-2'}}
          </td>
          <td cdk-footer-cell *cdkFooterCellDef class="text-right" style="width: 10%;" [hidden]="!view"></td>
        </ng-container>
        <ng-container cdkColumnDef="pricecat">
          <th cdk-header-cell *cdkHeaderCellDef style="width: 4%;" [hidden]="!view"></th>
          <td cdk-cell *cdkCellDef="let row" class="text-left" style="width: 4%;" [hidden]="!view">
            {{row.pricecat}}
          </td>
          <td cdk-footer-cell *cdkFooterCellDef style="width: 4%;" [hidden]="!view"></td>
        </ng-container>
        <ng-container cdkColumnDef="invprice">
          <th cdk-header-cell *cdkHeaderCellDef style="width: 10%;" [hidden]="!view">Invoice Price<br>Rs.</th>
          <td cdk-cell *cdkCellDef="let row; index as i;" class="p-0" style="width: 10%;" [hidden]="!view">
            <input (change)="updateVal(i, $event)" type="number" name="fExclPrice" id="fExclPrice" value="{{row.fExclPrice | number:'1.2-2'}}" class="no-border w-100 text-right">
          </td>
          <td cdk-footer-cell *cdkFooterCellDef class="text-right" style="width: 10%;" [hidden]="!view"></td>
        </ng-container>
        <ng-container cdkColumnDef="totalexcl">
          <th cdk-header-cell *cdkHeaderCellDef style="width: 10%;" [hidden]="!view">Total Excl<br>Rs.</th>
          <td cdk-cell *cdkCellDef="let row" class="text-right table-active" style="width: 10%;" [hidden]="!view">
            {{row.fExclPrice * row.qty | number:'1.2-2'}}
          </td>
          <td cdk-footer-cell *cdkFooterCellDef class="font-weight-bold text-right" style="width: 10%;" [hidden]="!view">
            {{totalexcl() | number:'1.2-2'}}
          </td>
        </ng-container>
        <ng-container cdkColumnDef="vat">
          <th cdk-header-cell *cdkHeaderCellDef style="width: 10%;" [hidden]="!view">VAT<br>Rs.</th>
          <td cdk-cell *cdkCellDef="let row" class="text-right table-active" style="width: 10%;" [hidden]="!view">
            {{(row.fExclPrice * (+row.TaxRate / 100)) * row.qty | number:'1.2-2'}}
          </td>
          <td cdk-footer-cell *cdkFooterCellDef style="width: 10%;" class="font-weight-bold text-right" [hidden]="!view">
            {{totalvat() | number:'1.2-2'}}
          </td>
        </ng-container>
        <ng-container cdkColumnDef="totalincl">
          <th cdk-header-cell *cdkHeaderCellDef style="width: 10%;" [hidden]="!view">Total Incl<br>Rs.</th>
          <td cdk-cell *cdkCellDef="let row" class="text-right table-active" style="width: 10%;" [hidden]="!view">
            {{(row.fExclPrice * ((+row.TaxRate / 100) + 1.00)) * row.qty | number:'1.2-2'}}
          </td>
          <td cdk-footer-cell *cdkFooterCellDef style="width: 10%;" class="font-weight-bold text-right" [hidden]="!view">
            {{totalincl() | number:'1.2-2'}}
          </td>
        </ng-container>
        <ng-container cdkColumnDef="edit">
          <th cdk-header-cell *cdkHeaderCellDef style="width: 4%;" [hidden]="!view"></th>
          <td cdk-cell *cdkCellDef="let row; index as i;" style="width: 4%;" [hidden]="!view" class="p-0">
              <button (click)="removeFromList(i)" type="button" class="tgt-button-full tgt-btn-white" style="margin: 5px;">
                <i class="material-icons" style="line-height: 24px;margin-top: 3px;">delete_forever</i>
              </button>
          </td>
          <td cdk-footer-cell *cdkFooterCellDef style="width: 4%;" [hidden]="!view" class="p-0">
              <button type="button" class="tgt-button-full tgt-btn-white" style="margin: 5px; opacity: 0;">
                <i class="material-icons" style="line-height: 24px;margin-top: 3px;">delete_forever</i>
              </button>
          </td>
        </ng-container>


        <ng-container cdkColumnDef="sprice">
          <th cdk-header-cell *cdkHeaderCellDef style="width: 10%;" [hidden]="view">Selling Price<br>Rs.</th>
          <td cdk-cell *cdkCellDef="let row" class="text-right table-active" style="width: 10%;" [hidden]="view">
            {{row.fExclPrice | number:'1.2-2'}}
          </td>
          <td cdk-footer-cell *cdkFooterCellDef class="text-right" style="width: 10%;" [hidden]="view"></td>
        </ng-container>
        <ng-container cdkColumnDef="cprice">
          <th cdk-header-cell *cdkHeaderCellDef style="width: 10%;" [hidden]="view">Cost Price<br>Rs.</th>
          <td cdk-cell *cdkCellDef="let row" class="text-right table-active" style="width: 10%;" [hidden]="view">
            {{row.AveUCst | number:'1.2-2'}}
          </td>
          <td cdk-footer-cell *cdkFooterCellDef class="text-right" style="width: 10%;" [hidden]="view"></td>
        </ng-container>
        <ng-container cdkColumnDef="uprofit">
          <th cdk-header-cell *cdkHeaderCellDef style="width: 10%;" [hidden]="view">Profit Per Unit<br>Rs.</th>
          <td cdk-cell *cdkCellDef="let row" class="text-right table-active" style="width: 10%;" [hidden]="view">
            {{(row.fExclPrice - row.AveUCst) | number:'1.2-2'}}
          </td>
          <td cdk-footer-cell *cdkFooterCellDef class="text-right" style="width: 10%;" [hidden]="view"></td>
        </ng-container>
        <ng-container cdkColumnDef="tprofit">
          <th cdk-header-cell *cdkHeaderCellDef style="width: 10%;" [hidden]="view">Total Profit<br>Rs.</th>
          <td cdk-cell *cdkCellDef="let row" class="text-right table-active" style="width: 10%;" [hidden]="view">
            {{(row.fExclPrice - row.AveUCst) * row.qty | number:'1.2-2'}}
          </td>
          <td cdk-footer-cell *cdkFooterCellDef class="text-right font-weight-bold" style="width: 10%;" [hidden]="view">
            {{totalprofit() | number:'1.2-2'}}
          </td>
        </ng-container>
        <ng-container cdkColumnDef="pprofit">
          <th cdk-header-cell *cdkHeaderCellDef style="width: 10%;" [hidden]="view">% Profit</th>
          <td cdk-cell *cdkCellDef="let row" class="text-right table-active" style="width: 10%;" [hidden]="view">
            {{((row.fExclPrice - row.AveUCst) / row.AveUCst) * 100 | number:'1.2-2'}}%
          </td>
          <td cdk-footer-cell *cdkFooterCellDef class="text-right" style="width: 10%;" [hidden]="view"></td>
        </ng-container>
      </table>
    </div>
  </div>
</div>

<table id="maintable" class="d-none">
  <thead>
      <tr>
          <th>Code</th>
          <th>Description</th>
          <th>Qty</th>
          <th>Unit Price//nMUR</th>
          <th>Price Ex VAT//nMUR</th>
          <th>VAT Rate//n%</th>
          <th>VAT Amount//nMUR</th>
          <th>Total Amount//nMUR</th>
      </tr>
  </thead>
  <tbody>
      <ng-container *ngFor="let prod of prodEnt$ | async; index as i; trackBy: trackByFn">
          <tr>
              <td>{{prod?.p_id}}</td>
              <td>{{prod?.Description_1}}//n{{prod?.Description_2}}//n{{prod?.Description_3}}</td>
              <td>{{prod?.qty}}</td>
              <td>{{prod?.fExclPrice | number:'1.2-2'}}</td>
              <td>{{prod?.fExclPrice * prod?.qty | number:'1.2-2'}}</td>
              <td>{{prod?.TaxRate | number:'1.0-0'}} %</td>
              <td>{{(prod?.TaxRate / 100) * (prod?.fExclPrice * prod?.qty) | number:'1.2-2'}}</td>
              <td>{{(prod?.fExclPrice * prod?.qty) + ((prod?.TaxRate / 100) * (prod?.fExclPrice * prod?.qty)) | number:'1.2-2'}}</td>
          </tr>
      </ng-container>
  </tbody>
</table>

<table id="totaltable" style="display: none;">
  <tbody>
      <tr class="last">
          <td></td>
          <td></td>
          <td></td>
          <td></td>
          <td class="bolder">
              {{totalexcl() | number:'1.2-2'}}
          </td>
          <td></td>
          <td class="bolder">
              {{totalvat() | number:'1.2-2'}}
          </td>
          <td class="bolder">
              {{totalincl() | number:'1.2-2'}}
          </td>
      </tr>
  </tbody>
</table>

<table id="signtable" style="display: none;">
  <thead>
      <tr>
          <th class="clear"></th>
          <th>Prepared by</th>
          <th>Delivered by</th>
          <th>Received by</th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td>Date</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td>Name</td>
          <td></td>
          <td></td>
      </tr>
      <tr>
          <td class="lilmore">Signature<br><br></td>
          <td></td>
          <td></td>
      </tr>
  </tbody>
</table>

<app-dialog
  dialogID="process"
  title="Process Proforma Invoice"
  size="small"
  accept="Process"
  cancel="Cancel"
  (onAccept)="processPDF()"
>
  <form [formGroup]="editForm">
    <div class="row">
      <div class="col-12">
        <div class="form-group">
          <label for="option">Option</label>
          <select formControlName="option" class="form-control w-100" name="option" id="option">
            <option value="confirm">Confirm</option>
            <option value="cancel">Cancel</option>
          </select>
        </div>
      </div>
    </div>
  </form>
</app-dialog>

<app-dialog
  dialogID="newprod"
  title="Add New Product"
  size="medium"
  accept="Add"
  cancel="Cancel"
  (onAccept)="addToTemp()"
  (onCancel)="tempProd = null"
  [disabled]="tempProd?.p_id"
>
  <form [formGroup]="searchProdForm">
    <div class="form-group position-relative">
      <label for="prodsearch">Search for Product</label>
      <input (keydown)="searchProd()" formControlName="prodsearch" type="search" name="prodsearch" id="prodsearch" class="form-control w-100">
    </div>
    <div class="form-group">
      <ng-container *ngFor="let prod of product$ | async">
        <div
          (click)="tempProd = prod"
          class="alert-secondary alert px-4 py-3 pointer point"
          [ngClass]="{
            'alert-secondary': tempProd?.p_id != prod.p_id,
            'alert-success': tempProd?.p_id == prod.p_id
          }"
        >
          <p class="mb-0">
            <strong>{{prod.p_id}}</strong> - {{prod.Description_1}} {{prod.Description_2}} {{prod.Description_3}}<br>
            <strong>Qty: </strong>{{prod.Qty_On_Hand | number:'1.0-0'}}<br>
            <strong>Cost Price: </strong>Rs. {{prod.AveUCst | number:'1.2-2'}}
          </p>
        </div>
      </ng-container>
    </div>
  </form>
</app-dialog>
